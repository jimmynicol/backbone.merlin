/*
-------------------
Backbone.Merlin
-------------------

v0.0.1

Copyright (c) 2013: James Nicol <james.andrew.nicol@gmail.com>
Distributed under MIT license

http://github.com/jimmynicol/backbone.merlin
*/

var Backbone=this.Backbone;Backbone||"undefined"!=typeof exports&&(Backbone=require("backbone"));var _=this._;_||"undefined"!=typeof exports&&(_=require("underscore")),Backbone.Merlin={},Backbone.Merlin.Slide=function(a,b){"use strict";function c(){}return b.extend(c.prototype,{cssProperties:{transform:["webkitTransform","MozTransform","msTransform","OTransform"],transitionDuration:["webkitTransitionDuration","MozTransitionDuration","msTransitionDuration","OTransitionDuration","transitionDuration"],transitionEnd:["webkitTransitionEnd","otransitionend","oTransitionEnd","msTransitionEnd","transitionend"]},canCssTransform:function(){var a,c,d;return a=document.body||document.documentElement,c=a.style,"undefined"==typeof c?!1:(d=!1,b.forEach(this.cssProperties.transform,function(a){"string"==typeof c[a]&&(d=!0)}),d)},smoothSlide:function(c){var d,e,f,g,h;if("undefined"==typeof c&&(c={}),!c.slider||!c.distance)throw"To slide the component needs a slider and distance property";return d=a(c.slider),e=c.distance,f=c.direction||"x",g=c.direction||"300",h=this.setTranslations(f,e),this.canCssTransform()?(b.forEach(this.cssProperties.transitionDuration,function(a){d.css(a,""+g+"ms")}),c.callback&&d.one(this.cssProperties.transitionEnd.join(" "),c.callback),b.forEach(this.cssProperties.transform.slice(0,2),function(a){d.css(a,h.translate3d)}),b.forEach(this.cssProperties.transform.slice(2,4),function(a){d.css(a,h.translate)}),void 0):(d.animate(h.moveMargin,g,c.callback),void 0)},setTranslations:function(a,b){var c={moveMargin:"",translate3d:"",translate:""};switch(a){case"x":c.moveMargin={marginLeft:""+-b+"px"},c.translate3d="translate3d("+-b+"px,0,0)",c.translate="translateX("+-b+"px)";break;case"y":c.moveMargin={marginTop:""+-b+"px"},c.translate3d="translate3d(0,"+-b+"px,0)",c.translate="translateY("+-b+"px)"}return c}}),c}(Backbone.$,_),Backbone.Merlin.Log=function(a){"use strict";function b(){}return a.extend(b.prototype,{canLog:function(){return this._canLog===!0?this._canLog:/log=/.test(window.location.search)&&"undefined"!=typeof console?(this._canLog=!0,!0):!1},logName:function(){return this.constructor.name||this.stateName()},log:function(){var a,b;this.canLog()&&(a=[].slice,b=[this.logName()+":"].concat(a.call(arguments)),console.log.apply(console,b))}}),b}(_),Backbone.Merlin.Base=function(a,b,c){"use strict";function d(a){this.options=a||{},this.$el=b(this.options.el),this.options.startOnInit=this.options.startOnInit||!0,this.routes={},this.initialisedStates=[],this.stateNames=[],this.log("Merlin Initialized")}return c.extend(d.prototype,a.Merlin.Slide.prototype,a.Merlin.Log.prototype,{$:function(a){return this.$el.find(a)},states:{},registerStates:function(){var a=this;this.initialisedStates=c.map(this.states,function(b,c){var d,e;return d=new b({model:a.model(),wizard:a}),e=d.displayName(),this.stateNames.push(e),0===c&&(a.routes[""]=e),a.routes[e]=e,a.routes[""+e+"/*path"]=e,a.log("'"+e+"' state registered"),d})},buildRouter:function(){var b=this;this.router=new a.Router({routes:this.routers}),this.router("next","next"),this.router("prev","prev"),a.history.on("route",function(a,d,e){switch(d){case"next":b.nextState();break;case"prev":b.prevState();break;default:c.indexOf(b.stateNames,d)>-1&&this.stateChange(d,e[0][0])}}),this.options.startOnInit&&a.history.start()},extend:function(){return c.extend}}),d}(Backbone,Backbone.$,_),Backbone.Merlin.State=function(a,b,c){"use strict";var d=a.View.extend({constructor:function(a){d.__super__.constructor.apply(this,arguments),this.options=c.extend(this.defaultOptions(),a),this.wizard=this.wizard||this.options.wizard,this.currentState="init",this._initialised=!1,this.options.model&&(this.model=this.options.model),this.renderLayout(),this.transitionListeners(),this.options.renderOnInit===!0&&this.trigger("init"),this.log("State initialised!")},defaultOptions:function(){return{renderOnInitialisation:!1,transitions:["init","show","hide","remove"]}},stateName:function(){throw"Not implemented: this state needs a name!"},renderLayout:function(){if(!this.layoutView)throw"A state needs a layout view to render";this.$el.html(this.layoutView()).addClass("view-state")},transitionListeners:function(){var a=this;this.on("init",function(){a.log("init triggered"),a.beforeInit.apply(a,arguments),a.renderViews(),a.init.apply(a,arguments),a._initialised=!0}),this.on("show",function(){a._initialised||(a.beforeInit.apply(a,arguments),a.renderViews(),a.init.apply(a,arguments),a._initialised=!0),a.$el.addClass("show"),a.$el.removeClass("hide"),a.show.apply(a,arguments)}),this.on("hide",function(){a.$el.addClass("hide"),a.$el.removeClass("show"),a.hide.apply(a,arguments)})},views:{},renderViews:function(){var a=this;this.log("rendering "+this.stateName()+" views"),c.forEach(this.views,function(b,c){this.views[c]=new b({el:c,model:this.model,state:this,wizard:this.wizard,log:function(){a.log.apply(this,arguments)}})})},makeUrlFriendly:function(a){return a.toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/(\s\s|\s)/gi,"-")},beforeInit:function(){},afterInit:function(){},show:function(){},hide:function(){},remove:function(){},isComplete:function(){return!1},isBlocked:function(){return!1}});return c.extend(d.prototype,a.Merlin.Log.prototype),d}(Backbone,Backbone.$,_),"undefined"!=typeof exports&&(module.exports=Backbone.Merlin);